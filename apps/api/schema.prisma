generator client {
    provider        = "prisma-client-py"
    previewFeatures = ["multiSchema"]
    interface       = "sync"
}

datasource db {
    provider = "postgresql"
    url      = env("DATABASE_URL")
    schemas  = ["public", "storage"]
}

model buckets {
    id                         String                       @id
    name                       String                       @unique(map: "bname")
    owner                      String?                      @db.Uuid
    created_at                 DateTime?                    @default(now()) @db.Timestamptz(6)
    updated_at                 DateTime?                    @default(now()) @db.Timestamptz(6)
    public                     Boolean?                     @default(false)
    avif_autodetection         Boolean?                     @default(false)
    file_size_limit            BigInt?
    allowed_mime_types         String[]
    owner_id                   String?
    objects                    objects[]
    s3_multipart_uploads       s3_multipart_uploads[]
    s3_multipart_uploads_parts s3_multipart_uploads_parts[]

    @@schema("storage")
}

model migrations {
    id          Int       @id
    name        String    @unique @db.VarChar(100)
    hash        String    @db.VarChar(40)
    executed_at DateTime? @default(now()) @db.Timestamp(6)

    @@schema("storage")
}

model objects {
    id                   String                @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
    bucket_id            String?
    name                 String?
    owner                String?               @db.Uuid
    created_at           DateTime?             @default(now()) @db.Timestamptz(6)
    updated_at           DateTime?             @default(now()) @db.Timestamptz(6)
    last_accessed_at     DateTime?             @default(now()) @db.Timestamptz(6)
    metadata             Json?
    path_tokens          String[]              @default(dbgenerated("string_to_array(name, '/'::text)"))
    version              String?
    owner_id             String?
    user_metadata        Json?
    buckets              buckets?              @relation(fields: [bucket_id], references: [id], onDelete: NoAction, onUpdate: NoAction, map: "objects_bucketId_fkey")
    processed_pdfs       processed_pdfs?
    processed_pdf_images processed_pdf_images?

    @@unique([bucket_id, name], map: "bucketid_objname")
    @@index([bucket_id, name], map: "idx_objects_bucket_id_name")
    @@index([name], map: "name_prefix_search")
    @@schema("storage")
}

model s3_multipart_uploads {
    id                         String                       @id
    in_progress_size           BigInt                       @default(0)
    upload_signature           String
    bucket_id                  String
    key                        String
    version                    String
    owner_id                   String?
    created_at                 DateTime                     @default(now()) @db.Timestamptz(6)
    user_metadata              Json?
    buckets                    buckets                      @relation(fields: [bucket_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
    s3_multipart_uploads_parts s3_multipart_uploads_parts[]

    @@index([bucket_id, key, created_at], map: "idx_multipart_uploads_list")
    @@schema("storage")
}

model s3_multipart_uploads_parts {
    id                   String               @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
    upload_id            String
    size                 BigInt               @default(0)
    part_number          Int
    bucket_id            String
    key                  String
    etag                 String
    owner_id             String?
    version              String
    created_at           DateTime             @default(now()) @db.Timestamptz(6)
    buckets              buckets              @relation(fields: [bucket_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
    s3_multipart_uploads s3_multipart_uploads @relation(fields: [upload_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

    @@schema("storage")
}

enum message_content_type {
    text
    image
    pdf
    tool_use
    tool_result
    refusal

    @@map("message_content_type")
    @@schema("public")
}

enum message_role {
    developer
    system
    user
    tool

    @@map("message_role")
    @@schema("public")
}

enum widget_type {
    image
    chart

    @@map("widget_type")
    @@schema("public")
}

enum image_detail {
    auto
    low
    high

    @@map("image_detail")
    @@schema("public")
}

enum annotation_type {
    url_citation

    @@map("annotation_type")
    @@schema("public")
}

model threads {
    id          String     @id @default(uuid())
    external_id String?    @unique
    created_at  DateTime   @default(now())
    updated_at  DateTime   @updatedAt
    metadata    Json?      @db.JsonB
    messages    messages[]

    @@map("threads")
    @@schema("public")
}

model messages {
    id          String             @id @default(uuid())
    thread      threads            @relation(fields: [thread_id], references: [id], onDelete: Cascade)
    thread_id   String
    role        message_role       @default(user)
    name        String?
    tool_use_id String?
    refusal     String?
    contents    message_contents[]
    agent_class String
    created_at  DateTime           @default(now())
    updated_at  DateTime           @updatedAt
    tool_calls  tool_calls[]
    annotations annotations[]

    @@map("messages")
    @@schema("public")
}

model message_contents {
    id           String               @id @default(uuid())
    message      messages             @relation(fields: [message_id], references: [id], onDelete: Cascade)
    message_id   String
    type         message_content_type @default(text)
    image_url    String?
    image_detail image_detail?
    file_data    Bytes?
    file_id      String?
    file_name    String?
    text         String?
    widget_type  widget_type?
    widget_data  Json?                @db.JsonB
    created_at   DateTime             @default(now())
    updated_at   DateTime             @updatedAt

    @@map("message_contents")
    @@schema("public")
}

model tool_calls {
    id         String   @id @default(uuid())
    message_id String
    message    messages @relation(fields: [message_id], references: [id], onDelete: Cascade)
    name       String
    arguments  Json     @db.JsonB
    result     Json     @db.JsonB
    is_error   Boolean  @default(false)
    created_at DateTime @default(now())

    @@map("tool_calls")
    @@schema("public")
}

model annotations {
    id          String          @id @default(uuid())
    message_id  String
    message     messages        @relation(fields: [message_id], references: [id], onDelete: Cascade)
    type        annotation_type @default(url_citation)
    url         String?
    title       String?
    start_index Int?
    end_index   Int?
    created_at  DateTime        @default(now())

    @@map("annotations")
    @@schema("public")
}

model processed_pdfs {
    id               String                 @id @default(uuid())
    long_summary     String
    short_summary    String
    markdown_content String
    file_type        String
    object_id        String                 @unique @db.Uuid
    object           objects                @relation(fields: [object_id], references: [id], onDelete: Cascade)
    images           processed_pdf_images[]
    created_at       DateTime               @default(now())
    updated_at       DateTime               @updatedAt

    @@map("processed_pdfs")
    @@schema("public")
}

model processed_pdf_images {
    id                 String         @id @default(uuid())
    processed_pdf_id   String
    processed_pdf      processed_pdfs @relation(fields: [processed_pdf_id], references: [id], onDelete: Cascade)
    object_id          String         @unique @db.Uuid
    object             objects        @relation(fields: [object_id], references: [id], onDelete: Cascade)
    original_file_name String
    summary            String
    page               Int
    created_at         DateTime       @default(now())
    updated_at         DateTime       @updatedAt

    @@map("processed_pdf_images")
    @@schema("public")
}
